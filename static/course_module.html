<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Learn ‚Äì FluentMind</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', path='css/common.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', path='css/vocabulary.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', path='css/settings.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', path='css/course_learning.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', path='css/course_module.css') }}?v=2" />
</head>

<body class="vocabulary-page">
  <header>
    <div class="wrap row">
      <div class="brand">
        <img src="{{ url_for('static', path='img/logo-small.png') }}" alt="FluentMind logo" />
        <span>FluentMind</span>
      </div>
      <nav>
        <a href="/">Main</a>
        <a href="#" class="active">Learn now</a>
        <a href="/pricing">Pricing</a>
        <a href="/contacts">Contacts</a>
      </nav>
      <div class="lang">en | ua</div>
    </div>
  </header>

  <main class="wrap settings-wrapper">
    <aside class="settings-sidebar">
      <nav class="settings-nav" aria-label="Profile navigation">
        <button type="button">
          <img src="{{ url_for('static', path='img/settings/nav-learn.svg') }}" width="22" height="22" alt="" aria-hidden="true" />
          <span class="settings-nav__label"><a href='/learn'>Learn</a></span>
        </button>
        <button type="button">
          <img src="{{ url_for('static', path='img/settings/nav-vocabulary.svg') }}" width="22" height="22" alt="" aria-hidden="true" />
          <span class="settings-nav__label"><a href='/vocabulary'>Vocabulary</a></span>
        </button>
        <button type="button"  class="active">
          <img src="{{ url_for('static', path='img/settings/nav-previous-lessons.svg') }}" width="22" height="22" alt="" aria-hidden="true" />
          <span class="settings-nav__label">Course Content</span>
        </button>
        <button type="button">
          <img class="settings-nav__icon" src="{{ url_for('static', path='img/settings/nav-settings.svg') }}" width="22" height="22" alt="" aria-hidden="true" />
          <span class="settings-nav__label"><a href='/settings'>Settings</a></span>
        </button>
      </nav>
    </aside>
    <div class="course-content-wrapper">
      <div id="module-content" class="module-content">
          {% if module and module.rendered_html %}
              {{ module.rendered_html | safe }}
          {% else %}
              <div class="empty-state">
                  <h2>Content not found</h2>
                  <p>It seems this module hasn't been generated yet or is loading incorrectly.</p>
                  <a href="/learn/course{{ course.course_id }}" class="return-link">&larr; Back to Course Plan</a>
              </div>
          {% endif %}

          <div class="module-rating-section">
            <h3 class="rating-header">Rate this module</h3>
            
            <div class="rating-controls-wrapper">
              <label class="rating-option" for="rating-up">
                <input type="radio" name="rating" value="1" id="rating-up">
                <span class="emoji">üëç</span> 
                <span id="label-up">Thumbs Up</span>
              </label>
              
              <label class="rating-option" for="rating-down">
                <input type="radio" name="rating" value="0" id="rating-down">
                <span class="emoji">üëé</span> 
                <span id="label-down">Thumbs Down</span>
              </label>
            </div>
            
            <div class="review-area-wrapper">
              <label for="review-text" class="review-label">Write a review (optional):</label>
              <textarea id="review-text" class="review-textarea" rows="4" placeholder="What did you like or dislike about this module?"></textarea>
            </div>
            
            <button id="submit-review" class="submit-review-btn" onclick="sendPayload()">Submit Feedback</button>
          </div>

      </div>
    </div>
  </main>
  
  <footer>
    <div class="wrap">
      <div class="foot-top">
        <div class="foot-brand">
          <img src="{{ url_for('static', path='img/logo-large.png') }}" alt="FluentMind logo large" />
        </div>
        <ul class="contact-list">
          <li><img src="{{ url_for('static', path='img/icon-location.png') }}" alt="" /> <span><strong>Address:</strong> X street, city Zaporizhzhia, Ukraine</span></li>
          <li><img src="{{ url_for('static', path='img/icon-mail.png') }}" alt="" /> <span><strong>Email:</strong> vyshnevetskyivolodymyr@gmail.com</span></li>
          <li><img src="{{ url_for('static', path='img/icon-phone.png') }}" alt="" /> <span><strong>Phone:</strong> +38 (063) 7597571</span></li>
        </ul>
        <div>
          <div class="socials-foot">
            <img src="{{ url_for('static', path='img/instagram.png') }}" alt="Instagram" />
            <img src="{{ url_for('static', path='img/linkedin.png') }}" alt="LinkedIn" />
            <img src="{{ url_for('static', path='img/facebook.png') }}" alt="Facebook" />
          </div>
        </div>
      </div>
      <div class="foot-bottom">
        <span>¬©2025 FluentMind All rights reserved.</span>
        <a href="#">Privacy Policy</a>
        <a href="#">Terms of use</a>
        <a href="#">Sitemap</a>
      </div>
    </div>
  </footer>

<script>
  document.querySelectorAll('input[name="rating"]').forEach(radio => {
    radio.addEventListener('change', (e) => {

      document.querySelectorAll('.rating-option').forEach(option => {
        option.classList.remove('selected');
      });
      
      if (e.target.checked) {
        e.target.closest('.rating-option').classList.add('selected');
      }
    });
  });

  async function sendPayload(){
    const ratingInput = document.querySelector('input[name="rating"]:checked');
    if (!ratingInput) {
      alert("Please select a rating (Thumbs Up or Thumbs Down) before submitting.");
      return; 
    }
    const score = parseInt(ratingInput.value);

    const payload = {
      span_id: "{{ span_id }}",
      annotations: {
        module_id: {{ module.module_id }},
        course_id: {{ module.course_id }},
        score: score,
        review: document.getElementById("review-text").value
      }
    };
    
    try {
      const btn = document.getElementById("submit-review");
      const originalText = btn.innerText;
      btn.disabled = true;
      btn.innerText = "Submitting...";

      const response = await fetch("/api/submit-module-progress", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });

      if (response.ok) {
        btn.innerText = "Feedback Sent!";
        btn.style.backgroundColor = "#27ae60";
        setTimeout(() => {
          btn.innerText = "Submit Feedback";
          btn.disabled = false;
          btn.style.backgroundColor = "";
          document.getElementById("review-text").value = "";
          document.querySelectorAll('input[name="rating"]').forEach(r => r.checked = false);
          document.querySelectorAll('.rating-option').forEach(o => o.classList.remove('selected'));
        }, 3000);
      } else {
        const errorData = await response.json();
        console.error("Error submitting feedback:", errorData);
        alert("There was an error submitting your feedback. Please try again.");
        btn.disabled = false;
        btn.innerText = originalText;
      }
    } catch (error) {
      console.error("Network error:", error);
      alert("Network error. Please try again.");
      const btn = document.getElementById("submit-review");
      btn.disabled = false;
      btn.innerText = "Submit Feedback";
    }
  }


  document.getElementById("submit-review").addEventListener("click", async (e) => {
    e.preventDefault();
    await sendPayload();
  });
</script>
</body>
</html>
