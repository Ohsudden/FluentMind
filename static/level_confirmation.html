<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Confirm Your English Level – FluentMind</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', path='css/common.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', path='css/level-confirmation.css') }}" />
<link rel="stylesheet" href="{{ url_for('static', path='css/settings.css') }}" />

</head>
<body class="level-confirmation-page">
  <header>
    <div class="wrap row">
      <div class="brand">
        <img src="{{ url_for('static', path='img/logo-small.png') }}" alt="FluentMind logo" />
        <span>FluentMind</span>
      </div>
      <nav>
        <a href="/">Main</a>
        <a href="/registration" class="active">Learn now</a>
        <a href="/pricing">Pricing</a>
        <a href="/contacts">Contacts</a>
      </nav>
      <div class="lang">en | ua</div>
    </div>
  </header>

  <main class="wrap settings-wrapper">
    <aside class="settings-sidebar">
			<nav class="settings-nav" aria-label="Profile navigation">
				<button type="button" class="active">
					<img src="{{ url_for('static', path='img/settings/nav-learn.svg') }}" width="22" height="22" alt="" aria-hidden="true" />
					<span class="settings-nav__label"><a href='/learn'>Learn</a></span>
				</button>
				<button type="button">
					<img src="{{ url_for('static', path='img/settings/nav-vocabulary.svg') }}" width="22" height="22" alt="" aria-hidden="true" />
          <span class="settings-nav__label"><a href='/vocabulary'>Vocabulary</a></span>
				</button>
				<button type="button">
					<img src="{{ url_for('static', path='img/settings/nav-previous-lessons.svg') }}" width="22" height="22" alt="" aria-hidden="true" />
					<span class="settings-nav__label"><a href=''>Previous lessons</a></span>
				</button>
				<button type="button">
					<img class="settings-nav__icon" src="{{ url_for('static', path='img/settings/nav-settings.svg') }}" width="22" height="22" alt="" aria-hidden="true" />
					<span class="settings-nav__label"><a href='/settings'>Settings</a></span>
				</button>
			</nav>
		</aside>
    <div class="level-box">
      <h1>Confirm your English level</h1>
      <div class="options">
        <a class="option" href="#test" onclick="passTest()">
          <div class="icon"><img src="{{ url_for('static', path='img/level-pass-test.png') }}" alt="" /></div>
          <div class="text">
            <span class="title">Pass the test</span>
          </div>
          <span class="arrow">›</span>
        </a>
        <a class="option" href="#upload" onclick="uploadCertificate()">
          <div class="icon"><img src="{{ url_for('static', path='img/level-upload-cert.png') }}" alt="" /></div>
          <div class="text">
            <span class="title">Upload certificate</span>
          </div>
          <span class="arrow">›</span>
        </a>
        <a class="option" href="#no-level">
          <div class="icon"><img src="{{ url_for('static', path='img/level-no-level.png') }}" alt="" /></div>
          <div class="text">
            <span class="title">I don’t have an English level</span>
          </div>
          <span class="arrow">›</span>
        </a>
      </div>
    </div>
  </main>

  <footer>
    <div class="wrap">
      <div class="foot-top">
        <div class="foot-brand">
          <img src="{{ url_for('static', path='img/logo-large.png') }}" alt="FluentMind logo large" />
        </div>
        <ul class="contact-list">
          <li><img src="{{ url_for('static', path='img/icon-location.png') }}" alt="" /> <span><strong>Address:</strong> X street, city Zaporizhzhia, Ukraine</span></li>
          <li><img src="{{ url_for('static', path='img/icon-mail.png') }}" alt="" /> <span><strong>Email:</strong> vyshnevetskyivolodymyr@gmail.com</span></li>
          <li><img src="{{ url_for('static', path='img/icon-phone.png') }}" alt="" /> <span><strong>Phone:</strong> +38 (063) 7597571</span></li>
        </ul>
        <div>
          <div class="socials-foot">
            <img src="{{ url_for('static', path='img/linkedin.png') }}" alt="LinkedIn" />
            <img src="{{ url_for('static', path='img/instagram.png') }}" alt="Instagram" />
            <img src="{{ url_for('static', path='img/facebook.png') }}" alt="Facebook" />
          </div>
        </div>
      </div>
      <div class="foot-bottom">
        <span>©2025 FluentMind All rights reserved.</span>
        <a href="#">Privacy Policy</a>
        <a href="#">Terms of use</a>
        <a href="#">Sitemap</a>
      </div>
    </div>
  </footer>
  <script>
    function passTest(){
      if (document.getElementById('test-modal')) return;
      const modal = document.getElementsByClassName('level-box')[0];
      modal.innerHTML = `
        <div class="modal-content" id="test-modal">
          <button class="close-button" type="button" aria-label="Close" onclick="closeTestModal()">×</button>
          <h2>English Level Test</h2>
          <div id="test-status" class="status" aria-live="polite">Generating your test...</div>
        </div>`;
      
      Array.from(document.getElementsByClassName('options')).forEach(option => {
        option.style.display = 'none';
      });

      fetch('/api/generate-exam')
        .then(response => {
          if (response.status === 401) {
            throw new Error('Not authenticated. Please log in.');
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            const status = document.getElementById('test-status');
            status.textContent = 'Test generated successfully. Redirecting...';
            setTimeout(() => {
              window.location.href = `/learn?exam=${data.exam.id}`;
            }, 1200);
          } else {
            throw new Error(data.message || 'Failed to generate test.');
          }
        })
        .catch(err => {
          const status = document.getElementById('test-status');
          status.textContent = 'Error: ' + err.message;
        });
    }
    function uploadCertificate() {
      if (document.getElementById('upload-certificate-modal')) return;
      const modal = document.getElementsByClassName('level-box')[0];
      modal.innerHTML = `
        <div class="modal-content" id="upload-certificate-modal">
          <button class="close-button" type="button" aria-label="Close" onclick="closeUploadModal()">×</button>
          <h2>Upload Your English Certificate</h2>
          <form id="upload-certificate-form">
            <label for="certificate-file" class="file-input-label">
              <input type="file" id="certificate-file" name="file" accept=".pdf,.jpg,.jpeg,.png" />
              <span>Choose a file</span>
            </label>
            <button type="submit">Upload</button>
          </form>
          <div id="upload-status" class="status" aria-live="polite"></div>
        </div>`;
      
      Array.from(document.getElementsByClassName('options')).forEach(option => {
        option.style.display = 'none';
      });

      const form = document.getElementById('upload-certificate-form');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fileInput = document.getElementById('certificate-file');
        const status = document.getElementById('upload-status');
        const submitBtn = form.querySelector('button[type="submit"]');
        if (!fileInput.files.length) {
          status.textContent = 'Please choose a file first.';
          return;
        }
        console.log('[DEBUG] File selected:', fileInput.files[0].name);
        const data = new FormData();
        data.append('file', fileInput.files[0]);
        status.textContent = 'Uploading...';
        if (submitBtn) submitBtn.disabled = true;
        try {
          const resp = await fetch('/api/upload-certificate', { method: 'POST', body: data });
          if (resp.status === 401) {
            let json; try { json = await resp.json(); } catch {}
            status.textContent = (json && json.message) ? json.message : 'Not authenticated. Please log in.';
            return;
          }
          const json = await resp.json();
          if (json.success) {
            status.textContent = 'Uploaded successfully. Redirecting to file...';
            setTimeout(() => {
              window.location.href =  `/learn?file=${json.path.split('/')[1]}`;
            }, 1200);
          } else {
            status.textContent = json.message || 'Upload failed.';
          }
        } catch (err) {
          console.error(err);
          status.textContent = 'Network error: ' + err.message;
        } finally {
          if (submitBtn) submitBtn.disabled = false;
        }
      });
    }

    function closeUploadModal(){
      const m = document.getElementById('upload-certificate-modal');
      if (m) m.remove();
      setTimeout(() => {
              window.location.href =  `/learn`;
            }, 10);
    }

    {% if exam_content %}
    const currentTestId = "{{ test_id }}";
    document.addEventListener('DOMContentLoaded', function() {
        // Use tojson to safely serialize the string for JS, avoiding manual escape issues
        let contentStr = {{ exam_content | tojson }}; 
        console.log("Raw LLM content:", contentStr);

        let examData = null;
        try {
             // 1. Try removing markdown code blocks if they exist
            let cleanStr = contentStr.replace(/```json/g, '').replace(/```/g, '').trim();
            // 2. Try parsing
            try {
                examData = JSON.parse(cleanStr);
            } catch (e) {
                console.warn("Direct JSON parse failed, trying fuzzy matching...", e);
                // 3. Try finding the first '{' and last '}'
                const firstOpen = cleanStr.indexOf('{');
                const lastClose = cleanStr.lastIndexOf('}');
                if (firstOpen !== -1 && lastClose !== -1) {
                    const potentialJson = cleanStr.substring(firstOpen, lastClose + 1);
                    examData = JSON.parse(potentialJson);
                } else {
                    throw e;
                }
            }
        } catch (e) {
            console.error("Failed to parse exam JSON:", e);
        }

        const modal = document.getElementsByClassName('level-box')[0];
        
        let htmlContent = '';
        if (examData && examData.questions) {
            htmlContent += '<form id="exam-form">';
            examData.questions.forEach(q => {
                htmlContent += `<div class="question-block" style="margin-bottom: 20px; text-align: left;">
                    <p><strong>${q.id}. ${q.question}</strong></p>
                    <div class="answer-options">`;
                for (const [key, val] of Object.entries(q.options)) {
                    htmlContent += `<label style="display: block; margin: 5px 0; cursor: pointer;">
                        <input type="radio" name="${q.id}" value="${key}" required> 
                        <span style="font-weight: bold;">${key})</span> ${val}
                    </label>`;
                }
                htmlContent += `</div></div>`;
            });
            htmlContent += `<button type="button" onclick="submitExamAnswers()">Submit Answers</button>
            </form>`;
        } else {
             // Fallback for unstructured content
             console.warn("Falling back to text mode");
             htmlContent = `
             <div class="alert" style="color: red; margin-bottom: 10px;">Displaying raw text (Parsing failed)</div>
             <div style="margin-bottom: 10px;"><button type="button" onclick="passTest()">Regenerate Test</button></div>
             <div class="exam-content" style="text-align: left; white-space: pre-wrap; max-height: 50vh; overflow-y: auto; margin-bottom: 20px; border: 1px solid #ccc; padding: 10px;">${contentStr}</div>
              <form id="exam-form">
                  <textarea id="exam-answers" name="exam_answers" placeholder="Write your answers here (e.g., 1. A, 2. B...)" rows="5" style="width:100%; margin-bottom: 10px; padding: 10px;"></textarea>
                  <button type="button" onclick="submitExamAnswers()">Submit Answers</button>
              </form>`;
        }


        modal.innerHTML = `
          <div class="modal-content" id="exam-display">
              <h2>English Level Test</h2>
              <div style="max-height: 70vh; overflow-y: auto; padding-right: 10px;">
                ${htmlContent}
              </div>
              <div id="submission-status" class="status"></div>
          </div>`;
        
        Array.from(document.getElementsByClassName('options')).forEach(option => {
          option.style.display = 'none';
        });
    });

    function submitExamAnswers() {
        const form = document.getElementById('exam-form');
        const status = document.getElementById('submission-status');
        let answersPayload = null;
        
        if (form.querySelector('input[type="radio"]')) {
             const formData = new FormData(form);
             const answers = {};
             let allAnswered = true;
             
             const questions = form.querySelectorAll('.question-block');
             questions.forEach(qBlock => {
                 const inputs = qBlock.querySelectorAll('input[type="radio"]');
                 const name = inputs[0].name;
                 if (!formData.has(name)) {
                     allAnswered = false;
                 }
             });

             if (!allAnswered) {
                 status.textContent = "Please answer all questions.";
                 return;
             }
             
             for (const [key, value] of formData.entries()) {
                answers[key] = value;
             }
             answersPayload = JSON.stringify(answers); 
        } else {
             const textArea = document.getElementById('exam-answers');
             if (!textArea.value.trim()) {
                status.textContent = "Please write your answers.";
                return;
             }
             answersPayload = textArea.value;
        }

        status.textContent = "Submitting...";
        
        fetch('/api/submit-exam', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ exam_answers: answersPayload, test_id: currentTestId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                status.textContent = "Submitted successfully! Feedback: " + (data.feedback.content || "Received");
                alert("Feedback: " + (data.feedback.content || "Received"));
                window.location.href = "/learn"; 
            } else {
                status.textContent = "Error: " + data.message;
            }
        })
        .catch(err => {
            status.textContent = "Network error: " + err.message;
        });
    }
    {% endif %}
  </script>
</body>
</html>
